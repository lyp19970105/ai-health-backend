# 目标：实现图像对话的聊天记录保存功能

## 1. 最终目标

在用户进行图文混合对话后，将其中的**纯文本对话部分**（用户的提问文本和AI的回答文本）保存到数据库，且此过程应**复用现有代码逻辑**，不增加新的、重复的保存功能。

---

## 2. 现状分析

1.  **数据库层面**:
    *   现有 `messages` 表结构完全满足需求，**无需任何改动**。

2.  **代码逻辑层面 (`ChatService.java`)**:
    *   服务中已存在一个健壮的、用于保存纯文本对话的方法：`saveFullConversation`。
    *   处理图像对话的 `processVlmRequest` 方法在流程结束后，没有调用任何保存逻辑。

**结论**：我们唯一要做的，就是在 `processVlmRequest` 方法中，想办法调用**已经存在**的 `saveFullConversation` 方法。

---

## 3. 实现步骤

### 数据库结构调整

*   **无需任何调整**。

### 核心业务逻辑修改

1.  **修改聊天服务 (`ChatService.java`)**:
    *   **不创建任何新方法**。
    *   定位到 `processVlmRequest` 方法内部的 `.doOnTerminate()` 回调函数。
    *   在该函数内部，我们将调用**现有**的 `self.saveFullConversation(...)` 方法。
    *   为了匹配 `saveFullConversation` 方法的参数要求 (`FrontendChatRequest request, ...`)，我们会在调用前，根据当前上下文（用户输入的 `text`、`appConfig` 等）动态创建一个 `FrontendChatRequest` 对象。
    *   这个新创建的 `FrontendChatRequest` 对象将只包含用户的**纯文本提问**，然后被传递给保存方法。

**最终效果**：通过这种方式，无论是纯文本聊天还是图像聊天，最终都将汇入同一个、唯一的保存逻辑 (`saveFullConversation`)，从而完美确保了只有对话的文本部分被记录下来，且代码得到了最大程度的复用，避免了任何冗余和不一致性。
