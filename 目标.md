# 目标：实现图像对话的聊天记录保存功能

## 1. 最终目标

在用户进行图文混合对话时，能够像纯文本对话一样，将用户发送的图片、文字以及AI的回复完整地保存到数据库中。当用户后续查看历史记录时，可以清晰地看到当时的图片和对话内容。

---

## 2. 现状分析

通过阅读 `ChatService.java`、`MessageDO.java` 和 `ConversationDO.java`，发现当前系统存在以下问题，导致无法保存图像对话：

1.  **数据库层面 (`MessageDO.java`)**：
    *   `messages` 表对应的实体类 `MessageDO` 中，只有 `content` 字段用于存储文本内容。
    *   **缺少一个字段**来存储用户上传的图片信息。为了不引入文件存储的复杂性，我们可以直接保存图片的Base64编码数据。

2.  **代码逻辑层面 (`ChatService.java`)**：
    *   系统中有两个核心的聊天处理方法：`streamChat` (处理纯文本) 和 `streamVlmChat` (处理图像)。
    *   `streamChat` 方法的末尾调用了 `saveFullConversation` 方法，该方法负责将用户提问和AI回答存入数据库。
    *   而 `streamVlmChat` (及其辅助方法 `processVlmRequest`) 在流式响应结束后，**没有调用任何保存逻辑**。代码中明确标记了 `// TODO: 实现 VLM 对话的保存逻辑`。

**结论**：要实现目标，我们需要修改数据库实体和核心业务代码，以保存包含图片（Base64格式）的对话消息。

---

## 3. 实现步骤

我将按照以下步骤进行开发，此方案**无需**在服务器上保存实体图片文件，而是将图片数据直接存入数据库。

### 第一步：数据库结构调整

1.  **修改实体类 (`MessageDO.java`)**:
    *   在 `MessageDO` 实体中增加一个新的字段 `imageUrls`，用于存储与该条消息关联的图片信息。
    *   该字段设计为 `TEXT` 类型 (`@Lob`)，用以存储图片的 **Data URL** (Base64编码) 或外部图片链接。

    ```java
    // ... other fields
    @Lob
    @Column(name = "image_urls")
    private String imageUrls; // 存储图片的Data URL或普通URL
    // ... getters and setters
    ```

### 第二步：核心业务逻辑修改

1.  **修改聊天服务 (`ChatService.java`)**:
    *   创建一个新的、专门用于保存VLM对话的私有方法 `saveVlmConversation(...)`。
    *   修改 `streamVlmChat` 和 `streamVlmChatFromUrl` 方法：
        *   在流式响应结束时 (`doOnTerminate`)，调用新的 `saveVlmConversation` 方法，并将图片信息（Data URL 或普通 URL）传递过去。
    *   实现 `saveVlmConversation` 方法：
        *   该方法的逻辑将与现有的 `saveFullConversation` 非常相似。
        *   **保存用户消息时**：
            *   `role` 设置为 "user"。
            *   `content` 设置为用户的文本提问。
            *   `imageUrls` 设置为图片的 Data URL 或外部链接。
        *   **保存AI助手消息时**：
            *   `role` 设置为 "assistant"。
            *   `content` 设置为AI返回的完整文本。
            *   `imageUrls` 字段留空 (`null`)。
        *   两条消息都与同一个 `ConversationDO` 关联。

通过以上两个步骤，即可完成图像对话聊天记录的保存功能，将图片数据和文本上下文一起存入数据库，且无需管理服务器上的物理文件。
